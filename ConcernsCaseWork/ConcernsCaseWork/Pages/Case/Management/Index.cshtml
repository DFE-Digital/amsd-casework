@page "/case/{urn:long}/management"
@model ConcernsCaseWork.Pages.Case.Management.IndexPageModel
@using Service.TRAMS.Status;

@{
	ViewData["Title"] = "Case management";
	var nonce = HttpContext.GetNonce();
}

<div class="govuk-width-container">
	<partial name="_BannerError"/>

	@if (!string.IsNullOrEmpty((string)TempData.Peek("Error.Message")))
	{
		<partial name="_Error"/>
	}
	else
	{
		<div class="buttons-topOfPage">
			<a href="/" role="button" class="govuk-button govuk-button--secondary" data-module="govuk-button">
				Back to casework
			</a>
			@if (Model.IsEditableCase)
			{
				<a href="@Request.Path/closure" role="button" class="govuk-button govuk-button--warning float__right" data-module="govuk-button">
					Close case
				</a>
			}
		</div>

		<h1 class="govuk-heading-l" name="caseID">
			<span class="govuk-caption-m">Case ID</span>
			@Model.CaseModel.Urn
		</h1>

		<h2 class="govuk-heading-m">@Model.TrustDetailsModel.GiasData.GroupNameTitle</h2>

		<div class="govuk-tabs govuk-!-margin-top-6" data-module="govuk-tabs">

		<ul class="govuk-tabs__list">
			<li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
				<a class="govuk-tabs__tab" href="#case-details">
					Case Details
				</a>
			</li>
			<li class="govuk-tabs__list-item">
				<a class="govuk-tabs__tab" href="#trust-overview">
					Trust Overview
				</a>
			</li>
		</ul>
		<div class="govuk-tabs__panel" id="case-details">
			<dl class="govuk-summary-list summary-list-margin-0 govuk-!-margin-top-6">

				<!-- Trust -->
				<div class="govuk-summary-list__row">
					<dt class="govuk-summary-list__key">
						Trust
					</dt>
					<dd class="govuk-summary-list__value">
						@Model.TrustDetailsModel.GiasData.GroupName
					</dd>
					<dd class="govuk-summary-list__actions"></dd>
				</div>

				<!-- Risk to Trust -->
				<div class="govuk-summary-list__row">
					<dt class="dfe-width-30percent govuk-summary-list__key">
						Risk to trust
					</dt>
					<dd class="govuk-summary-list__value govuk-label-wrapper">
						@for (var index = 0; index < Model.CaseModel.RatingModel.RagRating.Item2.Count; ++index)
						{
							<span class="govuk-tag ragtag @Model.CaseModel.RatingModel.RagRatingCss.ElementAt(index)">
								@Model.CaseModel.RatingModel.RagRating.Item2.ElementAt(index)
							</span>
						}
					</dd>
					<dd class="govuk-summary-list__actions">
						@if (Model.IsEditableCase)
						{
							<a class="govuk-link" href="@Request.Path/edit_rating">
								Edit<span class="govuk-visually-hidden"> risk rating</span>
							</a>
						}
					</dd>
				</div>

				<!-- Direction of travel -->
				<div class="govuk-summary-list__row">
					<dt class="dfe-width-30percent govuk-summary-list__key">
						Direction of travel
					</dt>
					<dd class="govuk-summary-list__value">
						@Model.CaseModel.DirectionOfTravel
					</dd>
					<dd class="govuk-summary-list__actions">
						@if (Model.IsEditableCase)
						{
							<a class="govuk-link" href="@Request.Path/edit_directionoftravel">
								Edit<span class="govuk-visually-hidden"> direction of travel</span>
							</a>
						}
					</dd>
				</div>

				<!-- Concerns -->
				<div id="concerns-summary-list" class="govuk-summary-list__row">
					<dt class="govuk-summary-list__key">Concerns</dt>
					<dd class="govuk-summary-list__value">
						<div class="govuk-grid-row">

							@foreach (var concern in Model.CaseModel.RecordsModel)
							{
								<div class="govuk-!-padding-bottom-1">
									<span class="govuk-!-padding-right-1 govuk-grid-column-two-thirds">
										@concern.TypeModel.TypeDisplay
									</span>
									<div class="govuk-!-display-inline govuk-label-wrapper govuk-grid-column-two-third">
										@{
											if (concern.StatusModel.Name.Equals(StatusEnum.Close.ToString(), StringComparison.OrdinalIgnoreCase))
											{
												<span class="govuk-tag ragtag ragtag__grey">
													Closed
												</span>
											}
											else
											{
												for (var index = 0; index < concern.RatingModel.RagRating.Item2.Count; ++index)
												{
													<span class="govuk-tag ragtag @concern.RatingModel.RagRatingCss.ElementAt(index)">
														@concern.RatingModel.RagRating.Item2.ElementAt(index)
													</span>
												}
											}
										}
									</div>
								</div>
							}

						</div>
						<div class="govuk-o-grid__item--one-half">
							@if (Model.IsEditableCase)
							{
								<a href="@Request.Path/concern" class="govuk-link govuk-link-no-visited-state">Add concern</a>
							}
						</div>
					</dd>
					<dd class="govuk-summary-list__actions">
						@foreach (var concern in Model.CaseModel.RecordsModel)
						{
							if (concern.StatusModel.Name.Equals(StatusEnum.Close.ToString(), StringComparison.OrdinalIgnoreCase))
							{
								<br />
							}
							else
							{
								<div class="govuk-!-padding-bottom-1">
									<a class="govuk-link govuk-link-no-visited-state" href="@Request.Path/record/@concern.Urn/edit_rating">Edit</a>
								</div>
							}
						}
					</dd>
				</div>
			</dl>

			<!--Accordions-->
			<div class="govuk-accordion" data-module="govuk-accordion" id="accordion-default">

				<div class="govuk-accordion__section">
					<div class="govuk-accordion__section-header">
						<h2 class="govuk-accordion__section-heading">
							<span class="govuk-accordion__section-button" id="accordion-default-heading-1">Issue</span>
						</h2>
					</div>
					<div aria-labelledby="accordion-default-heading-1" class="govuk-accordion__section-content govuk-!-margin-top-3 govuk-!-margin-bottom-6" id="accordion-default-content-1">
						@if (Model.IsEditableCase)
						{
							<a class="govuk-link float__right" href="@Request.Path/edit_issue">Edit</a>
						}
						<div class="govuk-body details govuk-body-accordion-limit">
							<p class="word-break">@Model.CaseModel.Issue</p>
						</div>
					</div>
				</div>

				<div class="govuk-accordion__section">
					<div class="govuk-accordion__section-header">
						<h2 class="govuk-accordion__section-heading">
							<span class="govuk-accordion__section-button" id="accordion-default-heading-2">Current status</span>
						</h2>
					</div>
					<div aria-labelledby="accordion-default-heading-2" class="govuk-accordion__section-content govuk-!-margin-top-3 govuk-!-margin-bottom-6" id="accordion-default-content-2">
						@if (Model.IsEditableCase)
						{
							<a class="govuk-link float__right" href="@Request.Path/edit_current_status">Edit</a>
						}
						<div class="govuk-body details govuk-body-accordion-limit">
							<p class="word-break">@Model.CaseModel.CurrentStatus</p>
						</div>
					</div>
				</div>

				<div class="govuk-accordion__section">
					<div class="govuk-accordion__section-header">
						<h2 class="govuk-accordion__section-heading">
							<span class="govuk-accordion__section-button" id="accordion-default-heading-3">Case aim</span>
						</h2>
					</div>
					<div aria-labelledby="accordion-default-heading-3" class="govuk-accordion__section-content govuk-!-margin-top-3 govuk-!-margin-bottom-6" id="accordion-default-content-3">
						@if (Model.IsEditableCase)
						{
							<a class="govuk-link float__right" href="@Request.Path/edit_case_aim">Edit</a>
						}
						<div class="govuk-body details govuk-body-accordion-limit">
							<p class="word-break">@Model.CaseModel.CaseAim</p>
						</div>
					</div>
				</div>

				<div class="govuk-accordion__section">
					<div class="govuk-accordion__section-header">
						<h2 class="govuk-accordion__section-heading">
							<span class="govuk-accordion__section-button" id="accordion-default-heading-4">De-escalation point</span>
						</h2>
					</div>
					<div aria-labelledby="accordion-default-heading-4" class="govuk-accordion__section-content govuk-!-margin-top-3 govuk-!-margin-bottom-6" id="accordion-default-content-4">
						@if (Model.IsEditableCase)
						{
							<a class="govuk-link float__right" href="@Request.Path/edit_de_escalation_point">Edit</a>
						}
						<div class="govuk-body details govuk-body-accordion-limit">
							<p class="word-break">@Model.CaseModel.DeEscalationPoint</p>
						</div>
					</div>
				</div>

				<div class="govuk-accordion__section">
					<div class="govuk-accordion__section-header">
						<h2 class="govuk-accordion__section-heading">
							<span class="govuk-accordion__section-button" id="accordion-default-heading-5">Next steps</span>
						</h2>
					</div>
					<div aria-labelledby="accordion-default-heading-5" class="govuk-accordion__section-content govuk-!-margin-top-3 govuk-!-margin-bottom-6" id="accordion-default-content-5">
						@if (Model.IsEditableCase)
						{
							<a class="govuk-link float__right" href="@Request.Path/edit_next_steps">Edit</a>
						}
						<div class="govuk-body details govuk-body-accordion-limit">
							<p class="word-break">@Model.CaseModel.NextSteps</p>
						</div>
					</div>
				</div>
			</div>

			<partial name="_CaseHistory" model="@Model.CasesHistoryModel"/>

		</div>
		<div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="trust-overview">
			<partial name="_TrustOverview" model="@Model.TrustDetailsModel"/>
			<partial name="_Academies" model="@Model.TrustDetailsModel.Establishments"/>

			<table class="govuk-table  govuk-!-margin-top-9">
				<caption class="govuk-table__caption govuk-table__caption--m">
					Other cases
				</caption>
				<partial name="_TrustCases" model="@Model.TrustCasesModel"/>
			</table>
		</div>
		</div>
		
		<script type="application/javascript" nonce="@nonce">
			$(function () {
				$("button[id^='accordion-default-heading']").attr("aria-expanded", "true");
				$(".govuk-accordion__section").addClass("govuk-accordion__section--expanded");
			});
		</script>
	}
</div>